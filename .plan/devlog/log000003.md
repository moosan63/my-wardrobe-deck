# Dev Log 000003 - Phase 2: API/バックエンド

## 対象フェーズ
Phase 2: API/バックエンド

## 実施内容の要約

### 作成ファイル一覧

| ファイル | 内容 |
|---------|------|
| `app/lib/validation.ts` | Zodバリデーションスキーマ（createItemSchema, updateItemSchema） |
| `app/lib/api-response.ts` | APIレスポンスユーティリティ（成功/エラーレスポンス） |
| `app/routes/api/items/index.ts` | GET /api/items, POST /api/items |
| `app/routes/api/items/[id].ts` | GET/PUT/DELETE /api/items/:id |
| `tests/api/items.test.ts` | APIテスト（23テストケース） |

### 実装したAPIエンドポイント

| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/api/items` | 全アイテム取得（?category=xxxでフィルタ可） |
| POST | `/api/items` | アイテム作成 |
| GET | `/api/items/:id` | アイテム詳細取得 |
| PUT | `/api/items/:id` | アイテム更新 |
| DELETE | `/api/items/:id` | アイテム削除 |

### レスポンス形式
```json
// 成功
{ "success": true, "data": {...} }

// エラー
{ "success": false, "error": { "message": "..." } }
```

## 技術的判断・理由

### 1. HonoXテストの方式
vitest-pool-workersで`createApp()`は動作しないため、Honoを直接使用してルートハンドラをテストする方式を採用。

### 2. Zodスキーマ設計
- `categorySchema`を分離し、GET/POST/PUTで再利用
- `updateItemSchema`は全フィールドオプショナルで部分更新に対応

### 3. エラーメッセージ形式
Zodのバリデーションエラーは、最初のエラーのパスとメッセージを組み合わせて返す（例: `name: name cannot be empty`）

## レビュー内容と対応

### 必須指摘と対応

| 指摘 | 対応 |
|------|------|
| POST /api/items のJSON解析エラーハンドリング不足 | try-catch追加、400エラーを返すよう修正 |
| PUT /api/items/:id のJSON解析エラーハンドリング不足 | 同上 |
| 不正なJSONリクエストのテスト不足 | POST/PUT両方にテスト追加 |

### 推奨指摘（対応保留）
- categorySchemaとCATEGORIES定数の二重定義 → Phase 3以降で検討
- PUT空ボディ許容の方針明確化 → 現状許容（意図的）
- IDの最大値チェック → 実用上問題なしとして保留
- エラーメッセージの一貫性 → Phase 3以降で検討
- テストの重複コード削減 → リファクタリング時に対応

## 問題点・反省

HonoXのcreateApp()がvitest-pool-workersで動作しないことを発見。Honoを直接使用する方式でテスト可能だが、ルーティングの自動マウントはテストでは再現していない。

## 次フェーズへの申し送り

1. APIは完成しており、Phase 3のフロントエンドからfetchで呼び出し可能
2. curlでの動作確認は `npm run dev` 起動後に可能
3. マイグレーション適用後、実際のD1データベースでの動作確認が必要

## 完了条件の確認

- [x] 全APIテストがパス（40/40テスト成功）
- [ ] curlで各エンドポイント動作確認 → ユーザー確認項目
