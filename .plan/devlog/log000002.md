# Dev Log 000002 - Phase 1: データベース・モデル層

## 対象フェーズ
Phase 1: データベース・モデル層

## 実施内容の要約

### 作成ファイル一覧

| ファイル | 内容 |
|---------|------|
| `migrations/0001_create_items.sql` | D1マイグレーションファイル（itemsテーブル、インデックス） |
| `app/types/item.ts` | 型定義（Item, CreateItemInput, UpdateItemInput, Category） |
| `app/lib/constants.ts` | 定数定義（CATEGORIES, CATEGORY_LABELS, isValidCategory） |
| `app/db/items.ts` | DBアクセス層（CRUD関数6種） |
| `tests/db/items.test.ts` | Vitestテスト（17テストケース） |

### 実装したCRUD関数

- `getAllItems()` - 全アイテム取得（作成日時降順）
- `getItemById()` - ID指定取得
- `getItemsByCategory()` - カテゴリ別取得
- `createItem()` - 作成
- `updateItem()` - 更新（部分更新対応）
- `deleteItem()` - 削除

## 技術的判断・理由

### 1. インデックス追加
`idx_items_category`インデックスを追加。`getItemsByCategory()`のパフォーマンス向上のため。

### 2. RETURNING句の使用
`createItem`と`updateItem`で`RETURNING *`を使用し、追加クエリなしで作成/更新後のレコードを取得。

### 3. 部分更新の実装
`updateItem`は`undefined`と`null`を区別:
- `undefined`: そのフィールドは更新しない
- `null`: 明示的にnullを設定

### 4. テストスキーマのセットアップ
`db.exec()`は複数SQL文をサポートしないため、スキーマ定義を1行にまとめて実行。

## レビュー内容と対応

### 必須指摘
なし

### 推奨指摘と対応

| 指摘 | 対応 |
|------|------|
| R-1: `updated_at`更新のテスト追加 | テスト追加済み |
| R-2: brandをnullで更新するテスト追加 | テスト追加済み |

### 任意指摘（対応保留）
- O-2: getAllItemsの並び順テスト
- O-3: isValidCategory関数のテスト（Phase 2で対応予定）

## 問題点・反省

特になし。TDDサイクルに従って実装を進められた。

## 次フェーズへの申し送り

1. `isValidCategory`型ガード関数はPhase 2のバリデーション層で活用予定
2. DBアクセス層はテスト済みのため、Phase 2のAPI実装で直接使用可能
3. マイグレーション適用は`wrangler d1 migrations apply`で実行する

## 完了条件の確認

- [x] マイグレーション実行可能（ファイル作成済み）
- [x] 全CRUDテストがパス（17/17テスト成功）
